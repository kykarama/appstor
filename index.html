<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Metamekhanika · Serpentine</title>
  <meta name="description" content="One‑tap endless Serpentine. Tap to turn, collect dots, avoid your tail.">
  <style>
    :root{
      --bg:#0A0A0A; --grid:#141414; --head:#FFFFFF; --tail:#9BEA67; --food:#FF5C7A; --aura:#00E0FF; --ui:#EAEAEA; --meta:#7C3AED;
    }
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:16px;box-sizing:border-box}
    .phone{width:min(520px, 90vw); aspect-ratio:9/16; position:relative; border:1px solid #202020;
           border-radius:20px; overflow:hidden; box-shadow:0 20px 80px rgba(0,0,0,.6); background:#000}
    canvas{position:absolute; inset:0; width:100%; height:100%; touch-action:manipulation}
    .topbar{position:absolute; inset:0 0 auto 0; display:flex; justify-content:space-between; padding:10px; font-size:12px; opacity:.85}
    .bottombar{position:absolute; inset:auto 0 0 0; text-align:center; font-size:10px; padding:10px; opacity:.7}
    .overlay{position:absolute; inset:0; display:grid; place-items:center; background:transparent}
    .card{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.15); padding:16px 18px; border-radius:16px; backdrop-filter: blur(10px); text-align:center}
    .btn{display:inline-block; padding:8px 14px; border-radius:16px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.1); color:#fff; text-decoration:none; cursor:pointer}
    .cta{margin-top:10px; font-size:12px; opacity:.8}
  </style>
</head>
<body>
<div class="wrap">
  <div class="phone">
    <canvas id="game"></canvas>
    <div class="topbar"><div style="opacity:.9">МЕТАМЕХАНИКА</div><div>счёт: <b id="score">0</b> · рекорд: <b id="best">0</b></div></div>
    <div class="overlay" id="overlay">
      <div class="card">
        <div style="font-weight:600;margin-bottom:6px">Serpentine</div>
        <div style="opacity:.85;font-size:13px;margin-bottom:10px" id="hint">tap to start · удерживай ритм</div>
        <a class="btn" id="playBtn">Играть</a>
        <div class="cta">tap/click — смена поворота</div>
      </div>
    </div>
    <div class="overlay" id="over" style="display:none">
      <div class="card">
        <div style="font-weight:700;margin-bottom:4px">Проигрыш</div>
        <div style="opacity:.85;font-size:13px;margin-bottom:10px">счёт <span id="finalScore">0</span> · рекорд <span id="finalBest">0</span></div>
        <a class="btn" id="retryBtn">Ещё раз</a>
      </div>
    </div>
    <div class="bottombar">избегай стен и хвоста · собирай точки</div>
  </div>
</div>

<script>
(function(){
  const COLORS = { bg:'#0A0A0A', grid:'#141414', head:'#FFFFFF', tail:'#9BEA67', food:'#FF5C7A', aura:'#00E0FF', ui:'#EAEAEA', meta:'#7C3AED' };
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const overlay = document.getElementById('overlay');
  const over = document.getElementById('over');
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const finalScore = document.getElementById('finalScore');
  const finalBest = document.getElementById('finalBest');
  const playBtn = document.getElementById('playBtn');
  const retryBtn = document.getElementById('retryBtn');
  const hintEl = document.getElementById('hint');

  let running=false, gameOver=false, score=0, best= Number(localStorage.getItem('mm_serp_best')||0);
  bestEl.textContent = best;

  const S = {
    w:0,h:0,last:0,dt:0,px:0,py:0,angle:0,speed:140,turnDir:1,turnRate:Math.PI*0.9,tail:[],tailStep:8,maxTail:2000,food:{x:0,y:0},dpr:1
  };

  function LOGO_DRAW(ctx){
    const s=14;
    ctx.save();
    ctx.translate(16,16);
    ctx.scale(1.2,1.2);
    ctx.lineWidth = 2;
    ctx.strokeStyle = COLORS.meta;
    ctx.beginPath();
    ctx.arc(0,0,s,Math.PI*0.1,Math.PI*1.6,false);
    ctx.moveTo(-s*0.2,0); ctx.lineTo(s*0.9,0);
    ctx.stroke();
    ctx.restore();
  }

  function resize(){
    const dpr = Math.max(1, Math.min(3, window.devicePixelRatio||1));
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    S.w = canvas.width; S.h = canvas.height; S.dpr = dpr;
    reset(false);
  }
  window.addEventListener('resize', resize);

  function placeFood(){
    const margin = Math.min(S.w, S.h) * 0.08;
    S.food.x = margin + Math.random() * (S.w - margin*2);
    S.food.y = margin + Math.random() * (S.h - margin*2);
  }

  function reset(keepBest=true){
    S.px = S.w * 0.35;
    S.py = S.h * 0.5;
    S.angle = 0;
    S.turnDir = 1;
    S.tail.length = 0;
    S.tailStep = Math.max(6, Math.round(Math.min(S.w,S.h)/90));
    S.maxTail = 2000;
    S.speed = Math.max(90, Math.min(S.w,S.h)*0.25);
    S.turnRate = Math.PI*0.9;
    placeFood();
    score = 0;
    gameOver = false;
    running = false;
    scoreEl.textContent = score;
    if(!keepBest){ best = 0; bestEl.textContent = best; }
    hintEl.textContent = 'tap to start · удерживай ритм';
    overlay.style.display = 'grid';
    over.style.display = 'none';
    draw();
  }

  function start(){
    if (running) return;
    running = true;
    overlay.style.display = 'none';
    S.last = performance.now();
    requestAnimationFrame(loop);
  }

  function endGame(){
    running = false; gameOver = true;
    finalScore.textContent = score;
    finalBest.textContent = best;
    over.style.display = 'grid';
  }

  function input(ev){
    ev && ev.preventDefault();
    if (!running && !gameOver){ start(); return; }
    if (gameOver){ reset(); start(); return; }
    S.turnDir *= -1;
  }

  function loop(now){
    S.dt = Math.min(0.04, (now - S.last)/1000);
    S.last = now;
    update(S.dt);
    draw();
    if (running) requestAnimationFrame(loop);
  }

  function update(dt){
    S.angle += S.turnDir * S.turnRate * dt;
    S.px += Math.cos(S.angle)*S.speed*dt;
    S.py += Math.sin(S.angle)*S.speed*dt;

    const tail = S.tail;
    if (tail.length===0 || (Math.hypot(S.px - tail[tail.length-1].x, S.py - tail[tail.length-1].y) > S.tailStep)){
      tail.push({x:S.px,y:S.py});
      if (tail.length > S.maxTail) tail.shift();
    }

    if (S.px < 8 || S.py < 8 || S.px > S.w - 8 || S.py > S.h - 8){ endGame(); return; }

    for (let i=0; i<S.tail.length-20; i+=2){
      const p = S.tail[i];
      if (Math.hypot(S.px - p.x, S.py - p.y) < S.tailStep*0.8){ endGame(); return; }
    }

    if (Math.hypot(S.px - S.food.x, S.py - S.food.y) < 14){
      score += 1; scoreEl.textContent = score;
      if (score > best){ best = score; bestEl.textContent = best; localStorage.setItem('mm_serp_best', String(best)); }
      S.speed *= 1.02;
      placeFood();
    }
  }

  function draw(){
    ctx.fillStyle = COLORS.bg; ctx.fillRect(0,0,S.w,S.h);

    // grid
    ctx.strokeStyle = COLORS.grid; ctx.lineWidth = 1;
    const step = Math.max(20, Math.min(S.w,S.h)/18);
    ctx.beginPath();
    for(let x=0;x<S.w;x+=step){ ctx.moveTo(x,0); ctx.lineTo(x,S.h); }
    for(let y=0;y<S.h;y+=step){ ctx.moveTo(0,y); ctx.lineTo(S.w,y); }
    ctx.stroke();

    // tail
    ctx.strokeStyle = COLORS.tail;
    ctx.lineWidth = Math.max(2, step*0.12);
    ctx.lineJoin = 'round'; ctx.lineCap = 'round';
    ctx.beginPath();
    for (let i=0;i<S.tail.length;i++){ const p=S.tail[i]; if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); }
    ctx.stroke();

    // head aura
    ctx.beginPath(); ctx.arc(S.px,S.py,14,0,Math.PI*2); ctx.strokeStyle=COLORS.aura; ctx.lineWidth=2; ctx.stroke();
    // head
    ctx.beginPath(); ctx.arc(S.px,S.py,8,0,Math.PI*2); ctx.fillStyle=COLORS.head; ctx.fill();
    // food
    ctx.beginPath(); ctx.arc(S.food.x,S.food.y,7,0,Math.PI*2); ctx.fillStyle=COLORS.food; ctx.fill();

    // frame
    ctx.strokeStyle = COLORS.grid; ctx.lineWidth = 2; ctx.strokeRect(4.5,4.5,S.w-9,S.h-9);

    LOGO_DRAW(ctx);
  }

  // events
  canvas.addEventListener('mousedown', input);
  canvas.addEventListener('touchstart', input, {passive:false});
  document.addEventListener('keydown', (e)=>{ if(e.code==='Space'||e.code==='Enter') input(e); });
  // FIX: wire overlay buttons
  playBtn.addEventListener('click', (e)=>{ e.preventDefault(); start(); });
  retryBtn.addEventListener('click', (e)=>{ e.preventDefault(); reset(); start(); });

  resize(); // init
})();</script>
</body>
</html>
